<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>バーチャルドラムキット | Virtual Drum Kit</title>
  <meta name="description" content="キーボードとクリックで叩けるドラム。録音/再生、BPM・メトロノーム、量子化、複数トラック、JSON保存/読込対応。単一HTMLのモダンSPA。" />
  <style>
    :root{
      --bg: #0b0f17; --panel: rgba(255,255,255,.08); --panel-2: rgba(255,255,255,.12);
      --text:#e9eef6; --muted:#9fb0c8; --accent:#7dd3fc; --accent-2:#a78bfa; --good:#34d399; --bad:#fb7185; --warn:#fbbf24;
      --shadow: 0 10px 30px rgba(0,0,0,.45); --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;line-height:1.6;overflow-x:hidden}

    /* Studio-like ambient background */
    .backdrop{position:fixed;inset:0;z-index:-2;background:
      radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.25), transparent 60%),
      radial-gradient(1000px 700px at 80% 20%, rgba(14,165,233,.20), transparent 60%),
      radial-gradient(1200px 900px at 40% 80%, rgba(16,185,129,.18), transparent 60%),
      linear-gradient(120deg,#0b0f17,#0b1220 40%,#0a0d16);filter:saturate(110%)}
    .scanlines{position:fixed;inset:0;z-index:-1;pointer-events:none;background:repeating-linear-gradient(180deg,rgba(255,255,255,.02) 0 2px,transparent 2px 4px);mix-blend-mode:overlay;opacity:.35;animation:drift 10s linear infinite}
    @keyframes drift{to{transform:translateY(8px)}}

    .container{max-width:1200px;margin:0 auto;padding:28px 20px 80px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);border-radius:var(--radius);backdrop-filter:blur(10px) saturate(120%)}

    header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:16px}
    .title{display:flex;align-items:center;gap:14px}
    .logo{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
    .logo svg{filter:drop-shadow(0 6px 16px rgba(124,58,237,.5))}
    h1{font-size:clamp(18px,2.2vw,26px);margin:0;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}

    /* Top controls */
    .controls{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{cursor:pointer;border:none;background:rgba(255,255,255,.08);color:var(--text);padding:12px 14px;border-radius:14px;font-weight:700;letter-spacing:.3px;display:inline-flex;align-items:center;gap:8px;transition:.15s ease transform,.2s ease background}
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)} .btn:active{transform:translateY(0)} .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.rec{background:linear-gradient(135deg,rgba(251,113,133,.16),rgba(250,204,21,.18))}
    .btn.play{background:linear-gradient(135deg,rgba(125,211,252,.16),rgba(167,139,250,.18))}

    .status{margin-left:auto;display:flex;align-items:center;gap:10px;padding:0 10px 0 4px;color:var(--muted)}
    .led{width:10px;height:10px;border-radius:50%;background:#64748b;transition:.25s}
    .led.rec{background:var(--bad);box-shadow:0 0 0 6px rgba(251,113,133,.12)}
    .led.play{background:var(--accent);box-shadow:0 0 0 6px rgba(125,211,252,.12)}

    .meter{display:flex;align-items:center;gap:12px;padding:6px 10px;background:rgba(255,255,255,.06);border-radius:12px}
    .meter input[type=range]{width:180px}
    .label{color:var(--muted);font-size:12px}
    select, input[type=number]{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:10px;padding:8px 10px;font-weight:700}

    /* Audio gate */
    .audioGate{position:sticky; top:10px; z-index:10; display:flex; justify-content:center;}
    .audioGate .btn{background:linear-gradient(135deg,rgba(34,197,94,.18),rgba(125,211,252,.18))}

    /* Pads */
    .grid{display:grid;grid-template-columns:repeat(4,minmax(130px,1fr));gap:14px;padding:16px}
    .pad{position:relative;isolation:isolate;border-radius:20px;min-height:110px;cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.12);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;user-select:none;transition:.12s ease transform,.2s ease box-shadow,.2s ease background;box-shadow:var(--shadow)}
    .pad:hover{transform:translateY(-1px);background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06))}
    .pad:active,.pad.active{transform:scale(.98);box-shadow:0 12px 40px rgba(125,211,252,.25),var(--shadow)}
    .pad .name{font-weight:700;letter-spacing:.3px;margin-top:8px}
    .pad .keycap{position:absolute;top:10px;right:10px;font-size:12px;font-weight:700;color:#0b1220;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:6px 8px;border-radius:12px;box-shadow:0 6px 18px rgba(124,58,237,.35)}
    .pad .ring{position:absolute;inset:-2px;border-radius:22px;pointer-events:none;opacity:0;transform:scale(.9);background:radial-gradient(600px 220px at 50% 20%, rgba(125,211,252,.25), transparent 60%),radial-gradient(220px 600px at 50% 80%, rgba(167,139,250,.25), transparent 60%);transition:.25s ease opacity,.25s ease transform;mix-blend-mode:screen}
    .pad.active .ring{opacity:1;transform:scale(1)}

    /* Tracks */
    .tracks{margin-top:14px;padding:12px;display:grid;gap:10px}
    .track{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:8px 10px}
    .track input[type=text]{background:transparent;border:none;color:var(--text);font-weight:700;outline:none}
    .pill{padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-weight:700}
    .muted{opacity:.55}

    .help{margin-top:18px;color:var(--muted);font-size:14px;padding:14px 18px}
    .kbd{display:inline-block;min-width:20px;text-align:center;border-radius:8px;padding:2px 8px;margin:0 2px;font-weight:700;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.14);color:var(--text)}

    @media (max-width:760px){.grid{grid-template-columns:repeat(2,minmax(130px,1fr))} .controls{grid-template-columns:1fr} .meter input[type=range]{width:140px}}
  </style>
</head>
<body>
  <div class="backdrop"></div>
  <div class="scanlines"></div>

  <div class="container">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 8.5c0-2.2 4.5-4 9-4s9 1.8 9 4-4.5 4-9 4-9-1.8-9-4Z" stroke="white" opacity=".9" stroke-width="1.5"/>
            <path d="M3 8.5V15c0 2.2 4.5 4 9 4s9-1.8 9-4V8.5" stroke="white" opacity=".6" stroke-width="1.5"/>
            <path d="M7 7l10-5" stroke="#a78bfa" stroke-width="2" stroke-linecap="round"/>
            <circle cx="17" cy="2" r="1.8" fill="#7dd3fc"/>
          </svg>
        </div>
        <div>
          <h1>バーチャルドラムキット <span style="opacity:.6">/ Virtual Drum Kit</span></h1>
          <div class="subtitle">BPM・メトロノーム・量子化・複数トラック・JSON保存/読込つき。</div>
        </div>
      </div>

      <div class="panel controls" role="toolbar" aria-label="ドラム操作">
        <div class="row">
          <button class="btn rec" id="btnRecord" aria-pressed="false" title="録音開始 (R)">● 録音</button>
          <button class="btn play" id="btnPlay" title="再生 (P)">▶ 再生</button>
          <button class="btn" id="btnStop" disabled title="停止 (Space)">■ 停止</button>
          <button class="btn" id="btnClear" title="録音をクリア (C)">⟲ クリア</button>
          <div class="status" aria-live="polite">
            <div class="led" id="led"></div>
            <div id="statusText">Ready</div>
          </div>
        </div>
        <div class="row">
          <div class="meter">
            <span class="label">BPM</span>
            <input type="range" id="bpm" min="60" max="200" value="120" step="1"/>
            <input type="number" id="bpmNum" min="60" max="200" value="120" style="width:70px"/>
            <button class="btn" id="metronome">◉ メトロノーム</button>
          </div>
          <div class="meter">
            <span class="label">量子化</span>
            <select id="quantize">
              <option value="off">Off</option>
              <option value="8">1/8</option>
              <option value="16">1/16</option>
            </select>
          </div>
          <div class="meter">
            <button class="btn" id="btnExport">⇩ JSON書き出し</button>
            <label class="btn" for="importFile">⇧ JSON読み込み</label>
            <input type="file" id="importFile" accept="application/json" style="display:none"/>
          </div>
        </div>
      </div>
    </header>

    <div class="audioGate" id="audioGate">
      <button class="btn" id="btnAudio">🔈 サウンド有効化（クリックして音を許可）</button>
    </div>

    <main class="panel">
      <div class="grid" id="padGrid" aria-label="ドラムパッド">
        <button class="pad" data-sound="kick" data-key="A" aria-label="キック (A)"><div class="keycap">A</div><div class="ring"></div><div class="name">Kick</div></button>
        <button class="pad" data-sound="snare" data-key="S" aria-label="スネア (S)"><div class="keycap">S</div><div class="ring"></div><div class="name">Snare</div></button>
        <button class="pad" data-sound="hhc" data-key="D" aria-label="ハイハット(クローズ) (D)"><div class="keycap">D</div><div class="ring"></div><div class="name">Hi‑Hat (Closed)</div></button>
        <button class="pad" data-sound="hho" data-key="F" aria-label="ハイハット(オープン) (F)"><div class="keycap">F</div><div class="ring"></div><div class="name">Hi‑Hat (Open)</div></button>
        <button class="pad" data-sound="clap" data-key="H" aria-label="クラップ (H)"><div class="keycap">H</div><div class="ring"></div><div class="name">Clap</div></button>
        <button class="pad" data-sound="tom1" data-key="J" aria-label="ハイタム (J)"><div class="keycap">J</div><div class="ring"></div><div class="name">ハイタム</div></button>
        <button class="pad" data-sound="tom2" data-key="K" aria-label="ロータム (K)"><div class="keycap">K</div><div class="ring"></div><div class="name">ロータム</div></button>
        <button class="pad" data-sound="crash" data-key="L" aria-label="クラッシュシンバル (L)"><div class="keycap">L</div><div class="ring"></div><div class="name">Crash</div></button>
      </div>
    </main>

    <section class="tracks panel" id="tracks"></section>

    <div class="help panel" id="help">
      <div><strong>キー割り当て：</strong>
        <span class="kbd">A</span>Kick <span class="kbd">S</span>Snare <span class="kbd">D</span>Hi‑Hat(C)
        <span class="kbd">F</span>Hi‑Hat(O) <span class="kbd">H</span>Clap <span class="kbd">J</span>ハイタム <span class="kbd">K</span>ロータム <span class="kbd">L</span>Crash
      </div>
      <div style="margin-top:6px"><strong>ショートカット：</strong>
        <span class="kbd">R</span>録音 / 停止　<span class="kbd">P</span>再生　<span class="kbd">Space</span>停止　<span class="kbd">C</span>クリア
      </div>
      <div style="margin-top:6px; color:#cde7ff">音が出ない場合は、上の「🔈 サウンド有効化」を一度クリックしてね。</div>
    </div>
  </div>

  <script>
  (()=>{ 'use strict';
    // -------- Audio context & master chain --------
    let audioCtx=null, master, comp, reverb;
    const ensureAudio=async()=>{ 
      if(!audioCtx){ 
        const Ctx=window.AudioContext||window.webkitAudioContext; 
        audioCtx=new Ctx(); 
        master=audioCtx.createGain(); master.gain.value=0.9; 
        comp=audioCtx.createDynamicsCompressor(); comp.threshold.value=-18; comp.knee.value=28; comp.ratio.value=4; comp.attack.value=0.003; comp.release.value=0.25; 
        reverb=audioCtx.createConvolver(); reverb.buffer=createImpulse(audioCtx,1.6,0.25); 
        const dry=audioCtx.createGain(); dry.gain.value=0.85; const wet=audioCtx.createGain(); wet.gain.value=0.35; 
        master.connect(dry).connect(comp); master.connect(reverb).connect(wet).connect(comp); comp.connect(audioCtx.destination); 
      } 
      if(audioCtx.state==='suspended') await audioCtx.resume(); 
      const gate=document.getElementById('audioGate'); if(gate) gate.style.display='none';
      return audioCtx; 
    };
    function createImpulse(ctx,seconds=1.5,decay=0.3){ const rate=ctx.sampleRate,len=rate*seconds,imp=ctx.createBuffer(2,len,rate); for(let ch=0;ch<2;ch++){ const b=imp.getChannelData(ch); for(let i=0;i<len;i++){ b[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay*10); } } return imp; }
    function whiteNoise(ctx,seconds=1){ const len=ctx.sampleRate*seconds, buf=ctx.createBuffer(1,len,ctx.sampleRate), data=buf.getChannelData(0); for(let i=0;i<len;i++) data[i]=Math.random()*2-1; const src=ctx.createBufferSource(); src.buffer=buf; src.loop=false; return src; }

    // -------- Drum voices --------
    function playKick(v=1){ const ctx=audioCtx, now=ctx.currentTime; const o=ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(150,now); o.frequency.exponentialRampToValueAtTime(45,now+0.08); o.frequency.exponentialRampToValueAtTime(30,now+0.25); const g=ctx.createGain(); g.gain.setValueAtTime(1*v,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.35); o.connect(g).connect(master); o.start(now); o.stop(now+0.5); }
    function playSnare(v=1){ const ctx=audioCtx, now=ctx.currentTime; const body=ctx.createOscillator(); body.type='triangle'; body.frequency.setValueAtTime(180,now); const gb=ctx.createGain(); gb.gain.setValueAtTime(0.6*v,now); gb.gain.exponentialRampToValueAtTime(0.001,now+0.25); body.connect(gb).connect(master); body.start(now); body.stop(now+0.3); const n=whiteNoise(ctx,0.4); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2500; bp.Q.value=0.5; const g=ctx.createGain(); g.gain.setValueAtTime(0.9*v,now); g.gain.exponentialRampToValueAtTime(0.0001,now+0.22); n.connect(hp).connect(bp).connect(g).connect(master); n.start(now); n.stop(now+0.25); }
    function playHiHat(closed=true,v=1){ const ctx=audioCtx, now=ctx.currentTime; const n=whiteNoise(ctx,closed?0.2:1.2); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; hp.Q.value=0.9; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=9000; bp.Q.value=0.7; const g=ctx.createGain(); const dur=closed?0.08:0.6; g.gain.setValueAtTime((closed?0.6:0.45)*v,now); g.gain.exponentialRampToValueAtTime(0.0001,now+dur); n.connect(hp).connect(bp).connect(g).connect(master); n.start(now); n.stop(now+(closed?0.12:0.8)); }
    function playTom(freq=140,v=1){ const ctx=audioCtx, now=ctx.currentTime; const o=ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(freq,now); o.frequency.exponentialRampToValueAtTime(freq*0.6,now+0.25); const g=ctx.createGain(); g.gain.setValueAtTime(0.9*v,now); g.gain.exponentialRampToValueAtTime(0.0001,now+0.35); o.connect(g).connect(master); o.start(now); o.stop(now+0.4); }
    function playClap(v=1){ const ctx=audioCtx, now=ctx.currentTime; const burst=(t,amp)=>{ const n=whiteNoise(ctx,0.3); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1000; const g=ctx.createGain(); g.gain.setValueAtTime(amp*v,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.15); n.connect(hp).connect(g).connect(master); n.start(t); n.stop(t+0.2); }; burst(now+0.0,0.7); burst(now+0.015,0.6); burst(now+0.03,0.5); }
    function playCrash(v=1){ const ctx=audioCtx, now=ctx.currentTime; const n=whiteNoise(ctx,2.5); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=5000; hp.Q.value=0.9; const g=ctx.createGain(); g.gain.setValueAtTime(0.5*v,now); g.gain.exponentialRampToValueAtTime(0.0001,now+1.7); n.connect(hp).connect(g).connect(master); n.start(now); n.stop(now+2); }

    // -------- UI refs --------
    const pads=[...document.querySelectorAll('.pad')];
    const statusText=document.getElementById('statusText'); const led=document.getElementById('led');
    const btnRecord=document.getElementById('btnRecord'); const btnPlay=document.getElementById('btnPlay'); const btnStop=document.getElementById('btnStop'); const btnClear=document.getElementById('btnClear');
    const bpmSlider=document.getElementById('bpm'); const bpmNum=document.getElementById('bpmNum'); const metroBtn=document.getElementById('metronome'); const quantSel=document.getElementById('quantize');
    const tracksEl=document.getElementById('tracks'); const importFile=document.getElementById('importFile'); const btnExport=document.getElementById('btnExport');

    // -------- Key map --------
    const keyToSound={'KeyA':'kick','KeyS':'snare','KeyD':'hhc','KeyF':'hho','KeyH':'clap','KeyJ':'tom1','KeyK':'tom2','KeyL':'crash'};

    // -------- State --------
    let bpm=120; let isRecording=false; let recordStart=0; let timers=[];
    let quantMode='off'; // 'off' | '8' | '16'
    let activeTrack=0;
    const tracks=[
      {name:'Track 1', events:[], muted:false},
      {name:'Track 2', events:[], muted:false},
      {name:'Track 3', events:[], muted:false},
    ];

    // -------- Helpers --------
    const msPerBeat=()=> 60000/bpm;
    const gridMs=()=> quantMode==='8'? msPerBeat()/2 : quantMode==='16'? msPerBeat()/4 : 1; // 1ms when off
    const totalLength=(evs)=> evs.length? evs[evs.length-1].at : 0;

    function setMode(mode){
      if(mode==='rec'){ statusText.textContent=`Recording… tr${activeTrack+1}`; led.classList.remove('play'); led.classList.add('rec'); btnRecord.setAttribute('aria-pressed','true'); btnPlay.disabled=true; btnStop.disabled=false; btnClear.disabled=true; }
      else if(mode==='play'){ statusText.textContent='Playing…'; led.classList.remove('rec'); led.classList.add('play'); btnRecord.disabled=true; btnPlay.disabled=true; btnStop.disabled=false; btnClear.disabled=true; }
      else { const len=sumLength(); statusText.textContent=len? `Ready · ${Math.round(len/1000)}s`:'Ready'; led.classList.remove('rec','play'); btnRecord.disabled=false; btnRecord.setAttribute('aria-pressed','false'); btnPlay.disabled=sumEvents().length===0; btnStop.disabled=true; btnClear.disabled=sumEvents().length===0; }
    }

    function visualHit(sound){ const el=pads.find(p=>p.dataset.sound===sound); if(!el) return; el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),130); }

    function trigger(sound,v=1){ if(!audioCtx) ensureAudio(); switch(sound){ case 'kick':playKick(v);break; case 'snare':playSnare(v);break; case 'hhc':playHiHat(true,v);break; case 'hho':playHiHat(false,v);break; case 'tom1':playTom(160,v);break; case 'tom2':playTom(120,v);break; case 'clap':playClap(v);break; case 'crash':playCrash(v);break; } visualHit(sound); if(isRecording){ const t=Math.round(performance.now()-recordStart); const q=quantizeTime(t); tracks[activeTrack].events.push({sound, at:q}); renderTracks(); setMode('rec'); } }

    function quantizeTime(ms){ const g=gridMs(); if(g<=1) return ms; return Math.round(ms/g)*g; }

    function clearTimers(){ timers.forEach(clearTimeout); timers=[]; }

    function sumEvents(){ const all=[]; tracks.forEach((tr,i)=>{ if(tr.muted) return; tr.events.forEach(e=> all.push({ ...e, track:i })); }); all.sort((a,b)=>a.at-b.at); return all; }
    function sumLength(){ const arr=tracks.map(t=> totalLength(t.events)); return Math.max(0,...arr); }

    // -------- Metronome --------
    let metroOn=false; let metroTimer=null;
    function metroTick(){ if(!audioCtx) return; const ctx=audioCtx, now=ctx.currentTime; const o=ctx.createOscillator(); o.type='square'; const g=ctx.createGain(); g.gain.value=0.25; o.frequency.setValueAtTime(2000,now); g.gain.exponentialRampToValueAtTime(0.0001,now+0.03); o.connect(g).connect(master); o.start(now); o.stop(now+0.05); }
    function scheduleMetronome(){ if(!metroOn) return; const interval=msPerBeat(); metroTick(); metroTimer=setTimeout(scheduleMetronome, interval); }

    // -------- Transport --------
    function toggleRecord(){ if(!audioCtx) ensureAudio(); if(!isRecording){ tracks[activeTrack].events=[]; clearTimers(); isRecording=true; recordStart=performance.now(); setMode('rec'); } else { isRecording=false; setMode('ready'); } }
    function playBack(){ const all=sumEvents(); if(!all.length){ flash('まだ録音がありません'); return; } if(!audioCtx) ensureAudio(); setMode('play'); clearTimers(); all.forEach(ev=>{ timers.push(setTimeout(()=> trigger(ev.sound,1), ev.at)); }); timers.push(setTimeout(()=> stopAll(), Math.max(20,sumLength()+20))); }
    function stopAll(){ clearTimers(); isRecording=false; setMode('ready'); }
    function clearAll(){ if(sumEvents().length===0){ flash('クリアする録音がありません'); return; } tracks.forEach(t=> t.events=[]); renderTracks(); setMode('ready'); flash('録音をクリアしました'); }

    // -------- Tracks UI --------
    function renderTracks(){ tracksEl.innerHTML=''; tracks.forEach((tr,i)=>{ const row=document.createElement('div'); row.className='track'+(tr.muted?' muted':''); row.innerHTML=`
      <div><input type="radio" name="activeTrack" ${i===activeTrack?'checked':''} aria-label="録音対象" /></div>
      <input type="text" value="${tr.name}" aria-label="トラック名" />
      <div class="pill" title="イベント数">● ${tr.events.length} ev</div>
      <div class="row">
        <button class="btn" data-act="mute">${tr.muted?'Unmute':'Mute'}</button>
        <button class="btn" data-act="dup">複製</button>
        <button class="btn" data-act="del">削除</button>
      </div>`;
      row.querySelector('input[type=radio]').addEventListener('change',()=>{ activeTrack=i; setMode('ready'); renderTracks(); });
      const name=row.querySelector('input[type=text]'); name.addEventListener('input',()=> tr.name=name.value);
      row.querySelector('[data-act=mute]').addEventListener('click',()=>{ tr.muted=!tr.muted; renderTracks(); setMode('ready'); });
      row.querySelector('[data-act=dup]').addEventListener('click',()=>{ tracks.splice(i+1,0,{ name: tr.name+' copy', events: tr.events.map(e=>({...e})), muted:false }); renderTracks(); setMode('ready'); });
      row.querySelector('[data-act=del]').addEventListener('click',()=>{ if(tracks.length<=1){ flash('最低1トラックは必要です'); return; } tracks.splice(i,1); if(activeTrack>=tracks.length) activeTrack=tracks.length-1; renderTracks(); setMode('ready'); });
      tracksEl.appendChild(row);
    }); }

    // -------- Import/Export JSON --------
    function exportJSON(){ const data={ version:1, bpm, quant:quantMode, tracks }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='drumkit_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(a.href); }
    function importJSON(file){ const reader=new FileReader(); reader.onload=e=>{ try{ const data=JSON.parse(e.target.result); if(!data.tracks) throw new Error('invalid'); bpm = data.bpm || 120; quantMode = data.quant || 'off'; while(tracks.length) tracks.pop(); data.tracks.forEach(t=> tracks.push({ name:t.name||'Track', events:(t.events||[]).map(ev=>({sound:ev.sound, at:+ev.at||0})), muted:!!t.muted })); updateBpmUI(); renderTracks(); setMode('ready'); flash('読み込みました'); }catch(err){ flash('JSONが不正です'); } }; reader.readAsText(file); }

    // -------- Event wiring --------
    pads.forEach(p=>{ p.addEventListener('pointerdown',async(e)=>{ await ensureAudio(); const vel=e.pressure&&e.pressure>0? Math.min(1,Math.max(0.2,e.pressure)):1; trigger(p.dataset.sound,vel); }); });
    window.addEventListener('keydown',async(e)=>{ if(e.repeat) return; const code=e.code; if(code in keyToSound){ e.preventDefault(); await ensureAudio(); trigger(keyToSound[code],1); } else if(code==='KeyR'){ e.preventDefault(); toggleRecord(); } else if(code==='KeyP'){ e.preventDefault(); playBack(); } else if(code==='Space'){ e.preventDefault(); stopAll(); } else if(code==='KeyC'){ e.preventDefault(); clearAll(); } });

    btnRecord.addEventListener('click',toggleRecord); btnPlay.addEventListener('click',playBack); btnStop.addEventListener('click',stopAll); btnClear.addEventListener('click',clearAll);

    function updateBpmUI(){ bpmSlider.value=bpm; bpmNum.value=bpm; }
    bpmSlider.addEventListener('input',()=>{ bpm=+bpmSlider.value; bpmNum.value=bpm; if(metroOn){ clearTimeout(metroTimer); scheduleMetronome(); } setMode('ready'); });
    bpmNum.addEventListener('change',()=>{ let v=+bpmNum.value; if(isNaN(v)) v=120; v=Math.min(200,Math.max(60,v)); bpm=v; bpmSlider.value=bpm; if(metroOn){ clearTimeout(metroTimer); scheduleMetronome(); } setMode('ready'); });
    metroBtn.addEventListener('click',async()=>{ await ensureAudio(); metroOn=!metroOn; metroBtn.classList.toggle('play',metroOn); if(metroOn){ scheduleMetronome(); flash('メトロノーム ON'); } else { clearTimeout(metroTimer); flash('メトロノーム OFF'); } });
    quantSel.addEventListener('change',()=>{ quantMode=quantSel.value; flash('量子化: '+(quantMode==='off'?'Off':('1/'+quantMode))); });

    const btnAudio=document.getElementById('btnAudio');
    if(btnAudio){ btnAudio.addEventListener('click', async()=>{ await ensureAudio(); flash('サウンドを有効化しました'); }); }
    document.addEventListener('visibilitychange',()=>{ const gate=document.getElementById('audioGate'); if(!gate) return; if(!audioCtx || audioCtx.state!=='running'){ gate.style.display='flex'; } });

    // -------- Toast --------
    let toastTimer=0; function flash(msg){ clearTimeout(toastTimer); let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='26px'; t.style.transform='translateX(-50%)'; t.style.background='rgba(0,0,0,.65)'; t.style.color='white'; t.style.padding='10px 14px'; t.style.borderRadius='12px'; t.style.boxShadow='0 10px 30px rgba(0,0,0,.4)'; t.style.fontWeight='700'; t.style.letterSpacing='.3px'; t.style.zIndex='99'; document.body.appendChild(t); } t.textContent=msg; t.style.opacity='1'; toastTimer=setTimeout(()=> t.style.opacity='0', 1400); }

    // -------- Init --------
    function init(){ renderTracks(); updateBpmUI(); setMode('ready'); }
    init();
  })();
  </script>
</body>
</html>
